<!DOCTYPE html>
<meta charset="utf-8">
<html>
    <head>
        <script src="/socket.io/socket.io.js"></script>
        <script src="../js/prong.js"></script>
        <style>
BODY {
    font-family:helvetica;
    background-color:#333;
    color:white;
    height:100%;
    padding:0;
    margin:0;
}

IFRAME {
    padding:0;
    margin:0;
    border-width:0px;
    width:300px;
    height:100%;
    float:left;
}

#main {
    padding:50px;
    padding-left:50px;
    height:100%
}

A { color : steelblue;}

.trackName {
    position:absolute;
    left:-110px;
    width:100px;
    text-align:right;
    font-size:10pt;
}


/* waveform */

.area {
  fill:steelblue;
}

.over .area {
    fill:orange;
}

.line {
  stroke:steelblue;
  fill:none;
}

/* timeline */

.timeline path,
.timeline line {
  fill: none;
  stroke: white;
  shape-rendering: crispEdges;
}

.timeline text {
  fill:white;
  shape-rendering: crispEdges;
}

/* comper */

.comp {
    fill:white;
    opacity:0.2;
}

.inbetween {
  fill:transparent;
  cursor:hand;
}

.resizer {
    fill:red;
    opacity:0;
    cursor:ew-resize;
}

/* play line */

.playLine {
    background-color:green;
    width:1px;
    height:600px;
    top:0px;
    position:absolute;
}

.audioRegion rect {
  stroke:steelblue;
  fill:transparent;
}


#sequence {
    height:200px;
    margin-left:80px;
}

.pot, .slider {
    stroke : black;
    stroke-width : 1px;
    fill : white;
    fill-opacity : 1;
    cursor:pointer;
}

.slider rect {
  fill : black;
}

.pot text, .slider text {
  fill:black;
}

.pot path {
    fill:black;
}

path.pan {
    fill:steelblue;
}

.over path.pan {
    fill:orange;
}

.slider .background {
  fill:steelblue;
  stroke-width:0;
}

.over .slider .background {
  fill:orange;    
}

text {
    fill:white;
    font-size:10pt;
}

        </style>
    </head>
    <body>
       <!--  <iframe src="../"></iframe> -->
        <div id="main">
        Regions<br />
        <span>
        <br />
        You can have multiple sound clips or regions per track
        <br />
        <br />
        </span>
        <button id="getARoom">get a room</button>
        <br />
        <button id="play">play</button>
        <button id="stop">stop</button>
        <br />
        <br />
        <div id="sequence"></div>
        <div id="mixer"></div>
        </div>
        <script>



var pool = [
    {
        'id' : 'sax1',
        'src' : '../audio/nino_rota/sax1_clip.mp3'
    },
    // {
    //     'id' : 'bass_drum',
    //     'src' : '../audio/nino_rota/bass_drum.mp3'
    // },
    {
        'id' : 'cymbals',
        'src' : '../audio/nino_rota/cymbals.mp3'
    }
]


var tracks = [
    //'../audio/nino_rota/sax1_clip.mp3',

    {
        'name' : 'track1',
        'type' : 'audioRegions',
        'regions' : [
            {
                'clipId' : 'sax1',
                'clipStart' : 0,
                'clipEnd' : 8,
                'startTime' : 0 // time in the arrangement that the clip appears
            },
            {
                'clipId' : 'sax1',
                'clipStart' : 0,
                'clipEnd' : 2,
                'startTime' : 9
            }
        ]
    },
    {
        'name' : 'track2',
        'type' : 'audioRegions',
        'regions' : [
            {
                'clipId' : 'cymbals',
                'clipStart' : 25,
                'clipEnd' : 27,
                'startTime' : 0
            },
            {
                'clipId' : 'cymbals',
                'clipStart' : 25,
                'clipEnd' : 27,
                'startTime' : 2
            },
            {
                'clipId' : 'cymbals',
                'clipStart' : 25,
                'clipEnd' : 27,
                'startTime' : 4
            }
        ]
    }
]



var x = d3.scale.linear().domain([0, 60]).range([0, 800]);

sequence = prong.sequence()
    .x(x)
    .poolResources(pool)
    .tracks(tracks)
    .trackHeight(30)
    .audioOut(prong.audioContext().destination);

d3.select('#play').on('click', function(){sequence.play()});
d3.select('#stop').on('click', function(){
    if (sequence.playing()){
        sequence.stop()
    }else{
        // if already stopped, then clicking this button resets to zero
        sequence.currentTime(0);
    }
});

var state = {
    pool : sequence.poolResources(),
    tracks : sequence.tracks()
}


var mixer = prong.mixer().sequence(sequence);

function redraw(){
    d3.select('#sequence').call(sequence);
    d3.select('#mixer').text('').call(mixer);
}

state.tracks.forEach(function(track){
    if (!('volume' in track)) track.volume = 60;
    if (!('pan' in track)) track.pan = 0;
})

//var ub = prong.ubiquity( window, 'pool', ['buffer']);
var ub = prong.ubiquity( window, 'state', ['channel','buffer']);
ub.on('change', function(){

    console.log('got the UB change event')

    ub.ignoreChangeEvents(true);
    sequence.poolResources(state.pool).tracks(state.tracks);
    state.tracks = sequence.tracks();
    redraw();
    ub.ignoreChangeEvents(false);
});

redraw();


        </script>
    </body>
</html>