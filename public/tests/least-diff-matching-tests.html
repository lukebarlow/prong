<!DOCTYPE html>
<meta charset="utf-8">
<html>
    <head>
        <script src="../js/prong.js"></script>
        <script src="../js/d3.v3.js"></script>
        <script src="../js/audioMatchingTests.js"></script>
        <style>
BODY {
    font-family:helvetica;
    background-color:#333;
    color:white;
    height:100%;
    padding:0;
    margin:0;
}

IFRAME {
    padding:0;
    margin:0;
    border-width:0px;
    width:300px;
    height:100%;
    float:left;
}

#main {
    padding:50px;
    padding-left:350px;
    height:100%
}

BUTTON {
    position:relative;
    top:-15px;
}

/* waveform */

.area {
  fill:steelblue;
}

.line {
  stroke:steelblue;
  fill:none;
}

/* timeline */

.timeline path,
.timeline line {
  fill: none;
  stroke: white;
  shape-rendering: crispEdges;
}

.timeline text {
  fill:white;
  shape-rendering: crispEdges;
}

.playLine {
    background-color:green;
    width:1px;
    height:600px;
    top:0px;
    position:absolute;
}

        </style>
    </head>
    <body>
        <iframe src="./"></iframe>
        <div id="main">
        Least Difference Audio Matching<br />
        <span>
        <br />
        Match two audio clips by finding the relative position where the difference
        between the waveforms is least.
        <br />
        <br />
        </span>
        <div id="tests"></div>
        </div>
        <script>

        var height = 20,
            width = 800,
            frequencyBands = [600, 11000, 12000, Infinity],
            interval = 0.1;

        var passes = 0, fails = 0,
            testIndex = 0,
            testRates = [];

        function runNextTest(){
            runTest(tests[testIndex], function(){
                testIndex++;
                if (testIndex <= tests.length -1){
                    runNextTest();
                }else{
                    console.log('passed : ' + passes);
                    console.log('failed : ' + fails);
                    console.log('average rate : ' + d3.round(d3.mean(testRates),2));
                }
            })
        }

        runNextTest();
    
        function runTest(test, callback){

            var x = d3.scale.linear().domain([0, 20]).range([0, width]),
                sequence = prong.sequence()
                .x(x)
                .trackHeight(height)
                .audioOut(prong.audioContext().destination)
                .tracks([test.a, test.b]);

            var tests = d3.select('#tests');

            /////////////////// some basic controls : start, stop, volume //////
            var controls = tests.append('div')
                .style('white-space','nowrap')
                .style('height','36px')
                //.style('display','none');

            controls.append('button')
                .text('play')
                .on('click', function(){
                    sequence.play();
                })

            controls.append('button')
                .text('stop')
                .on('click', function(){
                    if (sequence.playing()){
                        sequence.stop()
                    }else{
                        // if already stopped, then clicking this button resets to zero
                        sequence.currentTime(0);
                    }
                })

            var sliderContainer = controls.append('svg').attr('height','36');

            var sliderA =  prong.slider()
                            .domain([0,100])
                            .width(30)
                            .height(140)
                            .horizontal(true)
                            .format(d3.format('f'))
                            .on('change', function(value){
                                sequence.trackVolume(0, value / 100.0);
                            });

            var sliderB =  prong.slider()
                            .domain([0,100])
                            .width(30)
                            .height(140)
                            .horizontal(true)
                            .format(d3.format('f'))
                            .on('change', function(value){
                                sequence.trackVolume(1, value / 100.0)
                            });

            sliderContainer.append('g').attr('transform','translate(20,3)').call(sliderA);
            sliderContainer.append('g').attr('transform','translate(200,3)').call(sliderB);
            /////////////////// end of controls //////

            var testContainer = tests.append('div')
                .style('height', (60 + 2*height) + 'px')
                .call(sequence);

            sequence.on('load', function(){

                var start = new Date();

                var testResult = prong.audioMatching.matchLeastDiff(sequence.tracks(), interval, frequencyBands);

                var end = new Date(),
                    testTime = end - start,
                    totalAudioTime = d3.sum(sequence.tracks(), function(track){return track.buffer.duration}),
                    testRate = testTime / totalAudioTime;

                testRates.push(testRate);

                sequence.timeline().fireChange();

                var miss = Math.abs(Math.abs(testResult) - Math.abs(test.offset));
                var passed = miss < 0.05

                testContainer.style('background-color',
                    miss == 0 ? '#040' : 
                    (miss < 0.025) ? '#dd8C00' :
                    (miss < 0.05) ? '#aa5C00' :
                    (miss < 0.5) ? 'pink' :
                    (testResult == 0) ? 'black' : '#400');

                console.log(test.offset + ' - ' + testResult + '(' + d3.round(miss,2) + ') / ' + (passed ? 'PASS' : 'FAIL'));
                console.log('test rate : ' + testRate);
                passed ? passes++ : fails++;


                callback();
            })
        }

        </script>
    </body>
</html>